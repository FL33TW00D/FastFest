<!doctype html>
<head>
    <meta charset="utf-8">
    <title>Festify+</title>
    <meta name="description" content="Which festival should I go to?">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Was making an annoying error so got rid of webmanifest -->
    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet"> 
    <link type="text/css" rel="stylesheet" href="/public/animate.css"/>
    <script src="https://kit.fontawesome.com/4dfe369057.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
</head>
<body style="background-color:#191414; overflow-x: hidden;">
<div id="app" v-cloak class="p-2" style="height:100vh; width:100vw; color:white; font-family:'Montserrat', sans-serif;">
    <span class="px-3" style="color:#1DB954; font-weight:600; font-size: 60px;">fastfest</span>
    <div class="container-fluid m-0 p-0" style="height:calc(100% - 100px);">
        <div v-if="authenticated === false" class="row h-100 mx-4">
            <div id="login" class="col-12 col-lg-5 col-xl-4 order-lg-2 my-auto">
                <div class="mx-auto" style="max-width: 400px;">
                    <div>
                        <span style="padding-bottom: 100%; width: 100%; border-radius: 50%; display: inline-block; background-size: cover;"
                              :style="[authenticated ? {'backgroundImage': 'url(' + profile.images[0].url + ')'} : {'backgroundImage': 'url(https://www.kirkham-legal.co.uk/wp-content/uploads/2017/02/profile-placeholder.png)'}]">
                        </span>
                    </div>
                    <div style="text-align: center;">
                        <span style="border-radius: 20px !important;">
                            <a href= "http://fastfest.herokuapp.com/api/login" class="btn btn-success" role="button" style="border-radius: 18px;margin: 10px;">
                                <i class="fab fa-spotify fa-lg"></i>
                                Login with Spotify
                            </a>
                        </span>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-7 col-xl-8 my-auto text-center">
                <h1>Log in with Spotify to find the best festival for you!</h1>
            </div>
        </div>
        <div v-else class="row h-100 mx-4">
            <div v-if="page === 0" id="login" class="col-12 my-auto">
                <div class="mx-auto" style="max-width: 500px;">
                    <div>
                        <span style="padding-bottom: 100%; width: 100%; border-radius: 50%; display: inline-block; background-size: cover;"
                              :style="[authenticated ? {'backgroundImage': 'url(' + profile.images[0].url + ')'} : {'backgroundImage': 'url(https://www.kirkham-legal.co.uk/wp-content/uploads/2017/02/profile-placeholder.png)'}]">
                        </span>
                    </div>
                    <div style="text-align: center;">
                        <span>{{ profile.display_name }}<br></span>
                        <span style="border-radius: 20px !important;">
                            <a @click="logout" class="btn btn-secondary" role="button" style="border-radius: 18px;margin: 10px;">
                                <i class="fab fa-spotify fa-lg"></i>
                                Logout
                            </a>
                        </span>
                    </div>
                </div>
            </div>
            <div v-if="page === total_pages" id="login" class="col-12 my-auto">
                <div class="mx-auto text-center h-100">
                    <!-- {{calculating ? 'Calculating' : matches[0].name}} -->
                    <div v-if="matches.length > 0" class="row h-100">
                        <div class="col-12">
                            <div class="mx-auto" style="max-width:320px;">
                                <span style="padding-bottom: 100%; width: 100%; border-radius: 2%; display:inline-block; background-size: cover;" 
                                      :style="[{'backgroundImage': 'url(' + matches[0].logo + ')'}]">
                                </span>
                            </div>
                        </div>
                        <div class="col-12" style="font-size: 40px;">{{matches[0].name}}</div>
                    </div>
                    <b-table borderless :items="matches" :columns="['Name']"></b-table>
                </div>
            </div>
        </div>
        
        <span v-if="authenticated">
            <div v-if="page < total_pages" style="text-align: center; position: absolute; bottom: 0; right: 0;">
                <span style="border-radius: 20px !important;">
                    <a @click="next_page" class="btn btn-secondary" role="button" style="border-radius: 18px;margin: 10px;">
                        Next
                        <i class="fas fa-arrow-right"></i>
                    </a>
                </span>
            </div>
            <div v-if="page > 0 && page < total_pages" style="text-align: center; position: absolute; bottom: 0; left: 0;">
                <span style="border-radius: 20px !important;">
                    <a @click="prev_page" class="btn btn-secondary" role="button" style="border-radius: 18px;margin: 10px;">
                        <i class="fas fa-arrow-left"></i>
                        Previous
                    </a>
                </span>
            </div>
        </span>
    </div>
</div>
</body>

<script>
let app = new Vue({
    el: '#app',
    data() {
        return {
            total_pages: 3,

            authenticated: null,
            access_token: '',
            profile: {},
            page: 0,
            moved_back: false,
            calculating: false,

            festivals: [],
            scoreMap: new Map(),
            shortMap: new Map(),
            mediumMap: new Map(),
            longMap: new Map(),
            nameMap: new Map(),
            
            matches: [],
        }
    },
    methods: {
        next_page() { 
            this.page++; 
            this.moved_back = false;
        },
        prev_page() {
            this.page--; 
            this.moved_back = true;
        },
        transition(current) {
            // if (!this.moved_back) {
            //     console.log('moved forward');
            //     if (current === 0) return 'slideLeft';
            //     // if (current === this.page) return 'slideRight';
            //     if (current === this.page) return 'slideLeft';
            //     else return 'slideRight';
                
            // }
            // else {
            //     console.log('moved back');
            //     if (current === this.page) return 'slideRight';
            //     else return 'slideLeft';
            //     // if (current < this.page) return 'slideLeft';
            //     // if (current === this.page) return 'slideLeft';
            // }
            return 'slideLeft';
        },
        async userAuthenticated(){
            //Authentication headers
            var headers = {  
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + this.access_token
                },
            }

            console.log('GETTING USER DATA');
            await fetch('https://api.spotify.com/v1/me', headers)
                .then(response => response.json())
                .then((data) => {
                    this.profile = data;
                    console.log(this.profile);
                })
            this.authenticated = true;


            console.log('POPULATING ARTISTS');
            // Parameters: Type: Num Entities to return, max 50.
                        // Offset: The index of the first entity to return
                        //Time Range: Longterm(Years), Mediumterm (6months), shortterm (4weeks)
            let artists = [];
            let rank = 0;
            await fetch('https://api.spotify.com/v1/me/top/artists?time_range=medium_term&limit=49', headers)
                .then(response => response.json())
                .then((data) => {
                    console.log(data);
                    for (let artist in data.items) if (!this.mediumMap.has(data.items[artist].name)) this.mediumMap.set(data.items[artist].name, rank++);
                });
            await fetch('https://api.spotify.com/v1/me/top/artists?time_range=medium_term&limit=50&offset=49', headers)
                .then(response => response.json())
                .then((data) => {
                    console.log(data);
                    for (let artist in data.items) if (!this.mediumMap.has(data.items[artist].name)) this.mediumMap.set(data.items[artist].name, rank++);
                });
            
            rank = 0;
            await fetch('https://api.spotify.com/v1/me/top/artists?time_range=long_term&limit=49', headers)
                .then(response => response.json())
                .then((data) => {
                    console.log(data);
                    for (let artist in data.items) if (!this.longMap.has(data.items[artist].name)) this.longMap.set(data.items[artist].name, rank++);
                });
            await fetch('https://api.spotify.com/v1/me/top/artists?time_range=long_term&limit=50&offset=49', headers)
                .then(response => response.json())
                .then((data) => {
                    //Loading artists into a simple array
                    console.log(data);
                    for (let artist in data.items) if (!this.longMap.has(data.items[artist].name)) this.longMap.set(data.items[artist].name, rank++);
                });

            console.log(this.mediumMap);
            console.log(this.longMap);
        },
        populateScoreMap(){
            this.mediumMap.forEach((value, key) => {
                this.scoreMap.set(key.toLowerCase(), this.scoringFunction(value));
                this.nameMap.set(key.toLowerCase(), key);
            });

            this.longMap.forEach((value, key) => {
                if (!this.scoreMap.has(key.toLowerCase())) {
                    this.scoreMap.set(key.toLowerCase(), this.scoringFunction(value));
                    this.nameMap.set(key.toLowerCase(), key);
                }
                else if (this.scoreMap.get(key.toLowerCase()) < this.scoringFunction(value) * 4/5) {
                    this.scoreMap.set(key.toLowerCase(), this.scoringFunction(value) * 4/5);
                } 
            });
            
            console.log(this.scoreMap);
        },
        scoringFunction(position, mapType){
            let scalingFactor = 0.05;
            let score = (100/Math.pow(2,(position * scalingFactor)));
            return score;
        },
        async calculate() {
            this.calculating = true;
            console.log('POPULATING FESTIVALS');

            await fetch('/api/skiddle')
                .then(response => response.json())
                .then(data => {
                    this.festivals = data;
                });
            
            console.log(this.festivals);
            console.log("Done");

            let matches = [];
            this.populateScoreMap();
            let bestMatch = {name : "", score: Number.MIN_VALUE, matchedArtists: []};
            for(var fest of this.festivals){
                let currentMatch = {name : fest.eventname, score: 0, matchedArtists: [], artists: [], logo: fest.largeimageurl};
                for(var art of fest.artists){
                    currentMatch.artists.push(art.name);
                    if(this.scoreMap.has(art.name.toLowerCase())){
                        currentMatch.score += this.scoreMap.get(art.name.toLowerCase());
                        currentMatch.matchedArtists.push(art.name);
                    }
                }
                if(currentMatch.score > 0 && typeof matches.find((element) => {return element.name === fest.eventname;}) === "undefined"){
                    matches.push(currentMatch);
                    if(currentMatch.score > bestMatch.score){
                        bestMatch = currentMatch;
                    }
                }
            }

            console.log(matches.sort((a, b) => (a.score < b.score) ? 1 : -1));
            console.log(bestMatch);
            this.matches = matches;

            this.calculating = false;
        },
        getHashParams(){
            var hashParams = {};
            var e, r = /([^&;=]+)=?([^&;]*)/g, q = window.location.hash.substring(1);
            while ( e = r.exec(q)) {
                hashParams[e[1]] = decodeURIComponent(e[2]);
            } 
            console.log(hashParams);
            return hashParams;
        },
        logout(){
            sessionStorage.removeItem('spotify-access-token');
            sessionStorage.removeItem('spotify-refresh-token');
            window.location = window.location.origin;
        }
    },
    created() {
        if (window.location.hash) {
            sessionStorage.setItem('spotify-access-token', this.getHashParams().access_token);
            sessionStorage.setItem('spotify-refresh-token', this.getHashParams().refresh_token);
            // console.log(window.location)
            window.location = window.location.origin;
        }
        else {
            if (sessionStorage.getItem('spotify-access-token')) {
                this.access_token = sessionStorage.getItem('spotify-access-token') 
                this.userAuthenticated();
            }
            else {
                this.authenticated = false;
            }
            
            console.log(this.access_token);
        }
    },
    watch: {
        page(newValue) {
            if (newValue === this.total_pages) {
                this.calculate();
            }
        }
    }
});
</script>

<style>
.slideRight-leave-active {
    transition: translate .6s ease-in-out;
}
.slideRight-leave-to /* .fade-leave-active below version 2.1.8 */ {
    translate: 120%;
}
.slideRight-enter-active {
    transition: translate .6s ease-in-out;
}
.slideRight-enter {
    translate: 120%;
}

.slideLeft-leave-active {
    transition: translate .6s ease-in-out;
}
.slideLeft-leave-to /* .fade-leave-active below version 2.1.8 */ {
    translate: -120%;
}
.slideLeft-enter-active {
    transition: translate .6s ease-in-out;
}
.slideLeft-enter {
    translate: -120%;
}
</style>