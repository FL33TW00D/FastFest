<!doctype html>
<head>
    <meta charset="utf-8">
    <title>Festify+</title>
    <meta name="description" content="Which festival should I go to?">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Was making an annoying error so got rid of webmanifest -->
    <!-- <link rel="manifest" href="site.webmanifest"> -->
    <link rel="apple-touch-icon" href="icon.png">
    <!-- Place favicon.ico in the root directory -->

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link type="text/css" rel="stylesheet" href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.css" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat&display=swap" rel="stylesheet"> 
    <script src="https://kit.fontawesome.com/4dfe369057.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>
</head>
<body>
<div id="app" class="p-3" style="height:100vh; width:100vw; text-align:center; color:white; background-color:#191414; font-family:'Montserrat', sans-serif;">
    <span style="color:#1DB954; font-weight:600; font-size: 60px; text-shadow: -0.5px 0.5px, 0.5px 0.5px, 0.5px -0.5px, -0.5px -0.5px; letter-spacing:-1px;">Festify+</span>
    <div class="container">
        <div id="login">
          <h1>Log in with spotify to find the best festival for you!</h1>
          <span style="border-radius: 20px !important;">
                <a href="http://localhost:3000/api/login" class="btn btn-success" role="button" style="border-radius: 18px;margin: 10px;">
                    <i class="fab fa-spotify fa-lg"></i>
                    Login to Spotify
                </a>
            </span>
        </div>
        <div>
            <button id="topArtists">Testing</button>
        </div>
        <div id="loggedin">
          <div id="user-profile">
          </div>
          <div id="oauth">
          </div>
        </div>
      </div>
</div>
</body>

<script>
let app = new Vue({
    el: '#app',
    data: {},
    computed: {},
    methods: {},
    mounted: async function () {
        let festivals = [];
        let pages = 0;
        await fetch('http://www.skiddle.com/api/v1/events/search/?api_key=62a2932a3c0079d4f2d0dd00abfade5f&eventcode=FEST&description=1&order=goingto&limit=100')
            .then(response => response.json())
            .then(data => {
            console.log(data);
            pages = Math.ceil(data.totalcount / 100);
            festivals.push.apply(festivals, data.results);
        });

        let base = 100;
        for (let i = 1; i < pages; i++){
            await fetch(`http://www.skiddle.com/api/v1/events/search/?api_key=62a2932a3c0079d4f2d0dd00abfade5f&eventcode=FEST&description=1&order=goingto&limit=100&offset=${base}`)
            .then(response => response.json())
            .then(data => {
                festivals.push.apply(festivals, data.results);
            });
            base += 100;
        }
        console.log(festivals);
    },
    watch: {}
});
</script>

<script>
let top_artists = new Vue({
    el: '#topArtists',
    data: {},
    computed: {},
    methods: {
        getHashParams(){
            var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        },

        scoringFunction(position){
            let scalingFactor = 0.1;
            let score = (100/Math.pow(2,(position * scalingFactor))).toFixed(2);
            return score;
        }
    },
    mounted: async function(){
        //Authentication headers
            var headers = {  
                method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + this.getHashParams().access_token
                    },
                }
            // Parameters: Type: Num Entities to return, max 50.
                        // Offset: The index of the first entity to return
                        //Time Range: Longterm(Years), Mediumterm (6months), shortterm (4weeks)
            let artists = [];
            await fetch('https://api.spotify.com/v1/me/top/artists?time_range=medium_term&limit=50', headers)
            .then((response) => {
                return response.json();
            })
            .then((data) => {
                console.log(data);
                //Loading artists into a simple array
                artists.push.apply(artists, data.items);
            });
            let scoreMap = new Map();
            for(let i = 0; i < artists.length; i++){
                scoreMap.set(artists[i].name, this.scoringFunction(i));
            }
            //Object to store festival with [Best Match ID, Best Match Score]
            let bestMatch = {
                id : 0,
                score: Number.MIN_VALUE
            };

            let currentScore = 0;

    }
});
</script>
